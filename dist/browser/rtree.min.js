(function(e,t){typeof module=="object"&&typeof module.exports=="object"&&(exports=module.exports=t()),typeof define=="function"&&define.amd&&define(t),typeof window=="object"&&(typeof e.Terraformer=="undefined"&&(e.Terraformer={}),e.Terraformer.RTree=t().RTree)})(this,function(){function n(){this._thens=[]}var e={},t;typeof this.navigator=="object"&&(t=this.Terraformer),typeof module=="object"&&typeof module.exports=="object"&&(t=require("terraformer")),n.prototype={then:function(e,t){this._thens.push({resolve:e,reject:t})},resolve:function(e){this._complete("resolve",e)},reject:function(e){this._complete("reject",e)},_complete:function(e,t){this.then=e==="resolve"?function(e,n){e(t)}:function(e,n){n(t)},this.resolve=this.reject=function(){throw new Error("Deferred already completed.")};for(var n=0;n<this._thens.length;n++){var r=this._thens[n];r[e]&&r[e](t)}delete this._thens}};var r=function(e){var i=3,s=6;isNaN(e)||(i=Math.floor(e/2),s=e);var o={x:0,y:0,w:0,h:0,id:"root",nodes:[]},u=function(){var e={};return function(t){var n=0;return t in e?n=e[t]++:e[t]=0,t+"_"+n}}();r.Rectangle.squarified_ratio=function(e,t,n){var r=(e+t)/2,i=e*t,s=i/(r*r);return i*n/s};var a=function(e,t,n){var s=[],o=[],u=[],a=1;if(!e||!r.Rectangle.overlap_rectangle(e,n))return u;var f={x:e.x,y:e.y,w:e.w,h:e.h,target:t};o.push(n.nodes.length),s.push(n);do{var l=s.pop(),c=o.pop()-1;if("target"in f)while(c>=0){var h=l.nodes[c];if(r.Rectangle.overlap_rectangle(f,h)){if(f.target&&"leaf"in h&&h.leaf===f.target||!f.target&&("leaf"in h||r.Rectangle.contains_rectangle(h,f))){"nodes"in h?(u=d(h,!0,[],h),l.nodes.splice(c,1)):u=l.nodes.splice(c,1),r.Rectangle.make_MBR(l.nodes,l),delete f.target,l.nodes.length<i&&(f.nodes=d(l,!0,[],l));break}"nodes"in h&&(a+=1,o.push(c),s.push(l),l=h,c=h.nodes.length)}c-=1}else if("nodes"in f){l.nodes.splice(c+1,1),l.nodes.length>0&&r.Rectangle.make_MBR(l.nodes,l);for(var p=0;p<f.nodes.length;p++)v(f.nodes[p],l);f.nodes.length=0,s.length===0&&l.nodes.length<=1?(f.nodes=d(l,!0,f.nodes,l),l.nodes.length=0,s.push(l),o.push(1)):s.length>0&&l.nodes.length<i?(f.nodes=d(l,!0,f.nodes,l),l.nodes.length=0):delete f.nodes}else r.Rectangle.make_MBR(l.nodes,l);a-=1}while(s.length>0);return u},f=function(e,t){var n=-1,i=[],s,o=function(e,t){return function(n){e._attach_data(t,n)}};i.push(t);var u=t.nodes;do{n!==-1&&(i.push(u[n]),u=u[n].nodes,n=-1);for(var a=u.length-1;a>=0;a--){var f=u[a];if("leaf"in f){n=-1;break}var l=r.Rectangle.squarified_ratio(f.w,f.h,f.nodes.length+1),c=Math.max(f.x+f.w,e.x+e.w)-Math.min(f.x,e.x),h=Math.max(f.y+f.h,e.y+e.h)-Math.min(f.y,e.y),p=r.Rectangle.squarified_ratio(c,h,f.nodes.length+2);if(n<0||Math.abs(p-l)<s)s=Math.abs(p-l),n=a}}while(n!==-1);return i},l=function(e){var t=h(e);while(e.length>0)c(e,t[0],t[1]);return t},c=function(e,t,n){var s=r.Rectangle.squarified_ratio(t.w,t.h,t.nodes.length+1),o=r.Rectangle.squarified_ratio(n.w,n.h,n.nodes.length+1),u,a,f;for(var l=e.length-1;l>=0;l--){var c=e[l],h={};h.x=Math.min(t.x,c.x),h.y=Math.min(t.y,c.y),h.w=Math.max(t.x+t.w,c.x+c.w)-h.x,h.h=Math.max(t.y+t.h,c.y+c.h)-h.y;var p=Math.abs(r.Rectangle.squarified_ratio(h.w,h.h,t.nodes.length+2)-s),d={};d.x=Math.min(n.x,c.x),d.y=Math.min(n.y,c.y),d.w=Math.max(n.x+n.w,c.x+c.w)-d.x,d.h=Math.max(n.y+n.h,c.y+c.h)-d.y;var v=Math.abs(r.Rectangle.squarified_ratio(d.w,d.h,n.nodes.length+2)-o);if(!a||!u||Math.abs(v-p)<u)a=l,u=Math.abs(v-p),f=v<p?n:t}var m=e.splice(a,1)[0];t.nodes.length+e.length+1<=i?(t.nodes.push(m),r.Rectangle.expand_rectangle(t,m)):n.nodes.length+e.length+1<=i?(n.nodes.push(m),r.Rectangle.expand_rectangle(n,m)):(f.nodes.push(m),r.Rectangle.expand_rectangle(f,m))},h=function(e){var t=e.length-1,n=0,r=e.length-1,i=0,s,o;for(var u=e.length-2;u>=0;u--){var a=e[u];a.x>e[n].x?n=u:a.x+a.w<e[t].x+e[t].w&&(t=u),a.y>e[i].y?i=u:a.y+a.h<e[r].y+e[r].h&&(r=u)}var f=Math.abs(e[t].x+e[t].w-e[n].x),l=Math.abs(e[r].y+e[r].h-e[i].y);return f>l?t>n?(s=e.splice(t,1)[0],o=e.splice(n,1)[0]):(o=e.splice(n,1)[0],s=e.splice(t,1)[0]):r>i?(s=e.splice(r,1)[0],o=e.splice(i,1)[0]):(o=e.splice(i,1)[0],s=e.splice(r,1)[0]),[{x:s.x,y:s.y,w:s.w,h:s.h,nodes:[s]},{x:o.x,y:o.y,w:o.w,h:o.h,nodes:[o]}]},p=function(e,t){return e.nodes=t.nodes,e.x=t.x,e.y=t.y,e.w=t.w,e.h=t.h,e},d=function(e,t,n,i){var s=[];if(!r.Rectangle.overlap_rectangle(e,i))return n;var o=function(e,t){return function(n){e._attach_data(t,n)}};s.push(i.nodes);do{var u=s.pop();for(var a=u.length-1;a>=0;a--){var f=u[a];r.Rectangle.overlap_rectangle(e,f)&&("nodes"in f?s.push(f.nodes):"leaf"in f&&(t?n.push(f):n.push(f.leaf)))}}while(s.length>0);return n},v=function(e,t){var n;if(t.nodes.length===0){t.x=e.x,t.y=e.y,t.w=e.w,t.h=e.h,t.nodes.push(e);return}var i=f(e,t),o=e;do{if(n&&"nodes"in n&&n.nodes.length===0){var u=n;n=i.pop();for(var a=0;a<n.nodes.length;a++)if(n.nodes[a]===u||n.nodes[a].nodes.length===0){n.nodes.splice(a,1);break}}else n=i.pop();if("leaf"in o||"nodes"in o||Array.isArray(o)){if(Array.isArray(o)){for(var c=0;c<o.length;c++)r.Rectangle.expand_rectangle(n,o[c]);n.nodes=n.nodes.concat(o)}else r.Rectangle.expand_rectangle(n,o),n.nodes.push(o);if(n.nodes.length<=s)o={x:n.x,y:n.y,w:n.w,h:n.h};else{var h=l(n.nodes);o=h,i.length<1&&(n.nodes.push(h[0]),i.push(n),o=h[1])}}else r.Rectangle.expand_rectangle(n,o),o={x:n.x,y:n.y,w:n.w,h:n.h}}while(i.length>0)};this.serialize=function(e){var t=new n;return e&&t.then(function(t){e(null,t)},function(t){e(t,null)}),t.resolve(o),t},this.deserialize=function(e,t,r){var i=Array.prototype.slice.call(arguments),s=new n;switch(i.length){case 1:t=o;break;case 2:typeof i[1]=="function"&&(t=o,r=i[1])}return r&&s.then(function(e){r(null,e)},function(e){r(e,null)}),s.resolve(p(t,e)),s},this.search=function(e,r){var i;if(e.type){var s=t.Tools.calculateBounds(e);i={x:s[0],y:s[1],w:Math.abs(s[0]-s[2]),h:Math.abs(s[1]-s[3])}}else i=e;var u=new n,a=[i,!1,[],o];if(i===undefined)throw"Wrong number of arguments. RT.Search requires at least a bounding rectangle.";return r&&u.then(function(e){r(null,e)},function(e){r(e,null)}),u.resolve(d.apply(this,a)),u},this.toJSON=function(e,t){var n=[],i=[],s={},a=3,f=1,l="";if(e&&!r.Rectangle.overlap_rectangle(e,o))return"";t?(a+=4,i.push(t.nodes.length),n.push(t.nodes),l+="var main_tree = {x:"+t.x.toFixed()+",y:"+t.y.toFixed()+",w:"+t.w.toFixed()+",h:"+t.h.toFixed()+",nodes:["):(i.push(o.nodes.length),n.push(o.nodes),l+="var main_tree = {x:"+o.x.toFixed()+",y:"+o.y.toFixed()+",w:"+o.w.toFixed()+",h:"+o.h.toFixed()+",nodes:[");do{var c=n.pop(),h=i.pop()-1;h>=0&&h<c.length-1&&(l+=",");while(h>=0){var p=c[h];if(!e||r.Rectangle.overlap_rectangle(e,p))if(p.nodes)if(f>=a){var d=s.length,v=u("saved_subtree");l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",load:'"+v+".js'}",s[v]=this.toJSON(e,p),h>0&&(l+=",")}else l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",nodes:[",f+=1,i.push(h),n.push(c),c=p.nodes,h=p.nodes.length;else if(p.leaf){var m=p.leaf.toJSON?p.leaf.toJSON():JSON.stringify(p.leaf);l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",leaf:"+m+"}",h>0&&(l+=",")}else p.load&&(l+="{x:"+p.x.toFixed()+",y:"+p.y.toFixed()+",w:"+p.w.toFixed()+",h:"+p.h.toFixed()+",load:'"+p.load+"'}",h>0&&(l+=","));h-=1}h<0&&(l+="]}",f-=1)}while(n.length>0);l+=";";for(var g in s)l+="\nvar "+g+" = function(){"+s[g]+" return(main_tree);};";return l},this.remove=function(e,r,i){var s=Array.prototype.slice.call(arguments),u;if(s[0].type){var f=t.Tools.calculateBounds(e);s[0]={x:f[0],y:f[1],w:Math.abs(f[0]-f[2]),h:Math.abs(f[1]-f[3])}}var l=new n;if(s.length<1)throw"Wrong number of arguments. RT.remove requires at least a bounding rectangle or GeoJSON.";switch(s.length){case 1:u=!1;break;case 2:typeof s[1]=="function"?(u=!1,i=s[1]):u=s[1]}i&&l.then(function(e){i(null,e)},function(e){i(e,null)}),s=[s[0],u,o];if(s[1]===!1){var c=0,h=[];do c=h.length,h=h.concat(a.apply(this,s));while(c!==h.length);l.resolve(h)}else l.resolve(a.apply(this,s));return l},this.insert=function(e,r,i){var s;if(e.type){var u=t.Tools.calculateBounds(e);s={x:u[0],y:u[1],w:Math.abs(u[0]-u[2]),h:Math.abs(u[1]-u[3])}}else s=e;var a=new n;if(arguments.length<2)throw"Wrong number of arguments. RT.Insert requires at least a bounding rectangle or GeoJSON and an object.";return i&&a.then(function(e){i(null,e)},function(e){i(e,null)}),a.resolve(v({x:s.x,y:s.y,w:s.w,h:s.h,leaf:r},o)),a}};return r.Rectangle=function(e,t,n,r){var i,s,o,u,a,f;e.x?(i=e.x,o=e.y,e.w!==0&&!e.w&&e.x2?(a=e.x2-e.x,f=e.y2-e.y):(a=e.w,f=e.h),s=i+a,u=o+f):(i=e,o=t,a=n,f=r,s=i+a,u=o+f),this.x1=this.x=function(){return i},this.y1=this.y=function(){return o},this.x2=function(){return s},this.y2=function(){return u},this.w=function(){return a},this.h=function(){return f},this.toJSON=function(){return'{"x":'+i.toString()+', "y":'+o.toString()+', "w":'+a.toString()+', "h":'+f.toString()+"}"},this.overlap=function(e){return this.x()<e.x2()&&this.x2()>e.x()&&this.y()<e.y2()&&this.y2()>e.y()},this.expand=function(e){var t=Math.min(this.x(),e.x()),n=Math.min(this.y(),e.y());return a=Math.max(this.x2(),e.x2())-t,f=Math.max(this.y2(),e.y2())-n,i=t,o=n,this},this.setRect=function(e,t,n,r){var i,s,o,u,a,f;e.x?(i=e.x,o=e.y,e.w!==0&&!e.w&&e.x2?(a=e.x2-e.x,f=e.y2-e.y):(a=e.w,f=e.h),s=i+a,u=o+f):(i=e,o=t,a=n,f=r,s=i+a,u=o+f)}},r.Rectangle.overlap_rectangle=function(e,t){return e.x<t.x+t.w&&e.x+e.w>t.x&&e.y<t.y+t.h&&e.y+e.h>t.y},r.Rectangle.contains_rectangle=function(e,t){return e.x+e.w<=t.x+t.w&&e.x>=t.x&&e.y+e.h<=t.y+t.h&&e.y>=t.y},r.Rectangle.expand_rectangle=function(e,t){var n,r;return e.x<t.x?n=e.x:n=t.x,e.y<t.y?r=e.y:r=t.y,e.x+e.w>t.x+t.w?e.w=e.x+e.w-n:e.w=t.x+t.w-n,e.y+e.h>t.y+t.h?e.h=e.y+e.h-r:e.h=t.y+t.h-r,e.x=n,e.y=r,e},r.Rectangle.make_MBR=function(e,t){if(e.length<1)return{x:0,y:0,w:0,h:0};t?(t.x=e[0].x,t.y=e[0].y,t.w=e[0].w,t.h=e[0].h):t={x:e[0].x,y:e[0].y,w:e[0].w,h:e[0].h};for(var n=e.length-1;n>0;n--)r.Rectangle.expand_rectangle(t,e[n]);return t},e.RTree=r,e});