(function(e,t){typeof module=="object"&&typeof module.exports=="object"&&(exports=module.exports=t()),typeof define=="function"&&define.amd&&define(t),typeof window=="object"&&(e.Terraformer=t())})(this,function(){function o(){var e=Array.prototype.slice.apply(arguments);typeof console!==undefined&&console.warn&&console.warn.apply(console,e)}function u(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e}function a(e,t){t=t||{};var n=Object.keys(t);for(var r in n)e[n[r]]=t[n[r]];return e}function f(e){switch(e.type){case"Point":return[e.coordinates[0],e.coordinates[1],e.coordinates[0],e.coordinates[1]];case"MultiPoint":return h(e.coordinates);case"LineString":return h(e.coordinates);case"MultiLineString":return l(e.coordinates);case"Polygon":return l(e.coordinates);case"MultiPolygon":return c(e.coordinates);case"Feature":return f(e.geometry);case"FeatureCollection":return p(e);case"GeometryCollection":return d(e);default:throw new Error("Unknown type: "+e.type)}}function l(e){var t=null,n=null,r=null,i=null;for(var s=0;s<e.length;s++){var o=e[s];for(var u=0;u<o.length;u++){var a=o[u],f=a[0],l=a[1];t===null?t=f:f<t&&(t=f),n===null?n=f:f>n&&(n=f),r===null?r=l:l<r&&(r=l),i===null?i=l:l>i&&(i=l)}}return[t,r,n,i]}function c(e){var t=null,n=null,r=null,i=null;for(var s=0;s<e.length;s++){var o=e[s];for(var u=0;u<o.length;u++){var a=o[u];for(var f=0;f<a.length;f++){var l=a[f],c=l[0],h=l[1];t===null?t=c:c<t&&(t=c),n===null?n=c:c>n&&(n=c),r===null?r=h:h<r&&(r=h),i===null?i=h:h>i&&(i=h)}}}return[t,r,n,i]}function h(e){var t=null,n=null,r=null,i=null;for(var s=0;s<e.length;s++){var o=e[s],u=o[0],a=o[1];t===null?t=u:u<t&&(t=u),n===null?n=u:u>n&&(n=u),r===null?r=a:a<r&&(r=a),i===null?i=a:a>i&&(i=a)}return[t,r,n,i]}function p(e){var t=[],n;for(var r=e.features.length-1;r>=0;r--)n=f(e.features[r].geometry),t.push([n[0],n[1]]),t.push([n[2],n[3]]);return h(t)}function d(e){var t=[],n;for(var r=e.geometries.length-1;r>=0;r--)n=f(e.geometries[r]),t.push([n[0],n[1]]),t.push([n[2],n[3]]);return h(t)}function v(e){return e*n}function m(e){return e*r}function g(e,t){for(var n=0;n<e.length;n++)typeof e[n][0]=="number"&&(e[n]=t(e[n])),typeof e[n]=="object"&&(e[n]=g(e[n],t));return e}function y(e){var n=e[0],r=e[1];return[v(n/t)-Math.floor((v(n/t)+180)/360)*360,v(Math.PI/2-2*Math.atan(Math.exp(-1*r/t)))]}function b(e){var n=e[0],r=Math.max(Math.min(e[1],89.99999),-89.99999);return[m(n)*t,t/2*Math.log((1+Math.sin(m(r)))/(1-Math.sin(m(r))))]}function w(e,t,n){if(e.type==="Point")e.coordinates=t(e.coordinates);else if(e.type==="Feature")e.geometry=w(e.geometry,t,!0);else if(e.type==="FeatureCollection")for(var r=0;r<e.features.length;r++)e.features[r]=w(e.features[r],t,!0);else if(e.type==="GeometryCollection")for(var s=0;s<e.geometries.length;s++)e.geometries[s]=w(e.geometries[s],t,!0);else e.coordinates=g(e.coordinates,t);return n||t===b&&(e.crs=i),t===y&&delete e.crs,e}function E(e){return w(e,b)}function S(e){return w(e,y)}function x(e,t){return e<t?-1:e>t?1:0}function T(e,t,n){return x((t[0]-e[0])*(n[1]-e[1])-(n[0]-e[0])*(t[1]-e[1]),0)}function N(e,t){var n=t[0]-e[0],r=t[1]-e[1];return n*n+r*r}function C(e,t){var n=t;for(var r in e){var i=T(t,n,e[r]);if(i===-1||i===0&&N(t,e[r])>N(t,n))n=e[r]}return n}function k(e){function t(e,t){return e[0]-t[0]>e[1]-t[1]?1:e[0]-t[0]<e[1]-t[1]?-1:0}if(e.length===0)return[];if(e.length===1)return e;var n=[e.sort(t)[0]];for(var r=0;r<n.length;r++){var i=C(e,n[r]);i!==n[0]&&n.push(i)}return n}function L(e,t){var n=!1;for(var r=-1,i=e.length,s=i-1;++r<i;s=r)(e[r][1]<=t[1]&&t[1]<e[s][1]||e[s][1]<=t[1]&&t[1]<e[r][1])&&t[0]<(e[s][0]-e[r][0])*(t[1]-e[r][1])/(e[s][1]-e[r][1])+e[r][0]&&(n=!0);return n}function A(e,t){if(e&&e.length){if(e.length===1)return L(e[0],t);if(L(e[0],t)){for(var n=1;n<e.length;n++)if(L(e[n],t))return!1;return!0}return!1}return!1}function O(e,t,n,r){var i=(r[0]-n[0])*(e[1]-n[1])-(r[1]-n[1])*(e[0]-n[0]),s=(t[0]-e[0])*(e[1]-n[1])-(t[1]-e[1])*(e[0]-n[0]),o=(r[1]-n[1])*(t[0]-e[0])-(r[0]-n[0])*(t[1]-e[1]);if(o!==0){var u=i/o,a=s/o;if(0<=u&&u<=1&&0<=a&&a<=1)return!0}return!1}function M(e,t){for(var n=0;n<e.length-1;n++)for(var r=0;r<t.length-1;r++)if(O(e[n],e[n+1],t[r],t[r+1]))return!0;return!1}function _(e,t){for(var n=0;n<t.length;n++){var r=t[n];for(var i=0;i<r.length-1;i++)for(var s=0;s<e.length-1;s++)if(O(r[i],r[i+1],e[s],e[s+1]))return!0}return!1}function D(e,t){for(var n=0;n<e.length;n++)if(_(e[n],t))return!0;return!1}function P(e,t){for(var n=0;n<t.length;n++)return _(e,t[n])?!0:!1}function H(e,t){for(var n=0;n<e.length;n++)return P(e[n],t)?!0:!1}function B(e,t){for(var n=0;n<e.length;n++)return H(e[n],t)?!0:!1}function j(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n].slice();F(r[0],r[r.length-1])===!1&&r.push(r[0]),t.push(r)}return t}function F(e,t){for(var n=0;n<e.length;n++)for(var r=0;r<t.length;r++)if(e[n]!==t[r])return!1;return!0}function q(e){if(e)switch(e.type){case"Point":return new R(e);case"MultiPoint":return new U(e);case"LineString":return new z(e);case"MultiLineString":return new W(e);case"Polygon":return new X(e);case"MultiPolygon":return new V(e);case"Feature":return new $(e);case"FeatureCollection":return new J(e);case"GeometryCollection":return new K(e);default:throw new Error("Unknown type: "+e.type)}}function R(e){var t=Array.prototype.slice.call(arguments);if(e&&e.type==="Point"&&e.coordinates)u(this,e);else if(e&&Array.isArray(e))this.coordinates=e;else{if(!(t.length>=2))throw"Terraformer: invalid input for Terraformer.Point";this.coordinates=t}this.type="Point",this.__defineGetter__("bbox",function(){return f(this)})}function U(e){if(e&&e.type==="MultiPoint"&&e.coordinates)u(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.MultiPoint";this.coordinates=e}this.type="MultiPoint",this.__defineGetter__("bbox",function(){return f(this)}),this.__defineGetter__("length",function(){return this.coordinates?this.coordinates.length:0})}function z(e){if(e&&e.type==="LineString"&&e.coordinates)u(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.LineString";this.coordinates=e}this.type="LineString",this.__defineGetter__("bbox",function(){return f(this)})}function W(e){if(e&&e.type==="MultiLineString"&&e.coordinates)u(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.MultiLineString";this.coordinates=e}this.type="MultiLineString",this.__defineGetter__("bbox",function(){return f(this)}),this.__defineGetter__("length",function(){return this.coordinates?this.coordinates.length:0})}function X(e){if(e&&e.type==="Polygon"&&e.coordinates)u(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.Polygon";this.coordinates=e}this.type="Polygon",this.__defineGetter__("bbox",function(){return f(this)})}function V(e){if(e&&e.type==="MultiPolygon"&&e.coordinates)u(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.MultiPolygon";this.coordinates=e}this.type="MultiPolygon",this.__defineGetter__("bbox",function(){return f(this)}),this.__defineGetter__("length",function(){return this.coordinates?this.coordinates.length:0})}function $(e){if(e&&e.type==="Feature"&&e.geometry)u(this,e);else{if(!(e&&e.type&&e.coordinates))throw"Terraformer: invalid input for Terraformer.Feature";this.geometry=e}this.type="Feature",this.__defineGetter__("bbox",function(){return f(this)})}function J(e){if(e&&e.type==="FeatureCollection"&&e.features)u(this,e);else{if(!Array.isArray(e))throw"Terraformer: invalid input for Terraformer.FeatureCollection";this.features=e}this.type="FeatureCollection",this.__defineGetter__("length",function(){return this.features?this.features.length:0}),this.__defineGetter__("bbox",function(){return f(this)})}function K(e){if(e&&e.type==="GeometryCollection"&&e.geometries)u(this,e);else if(Array.isArray(e))this.geometries=e;else{if(!e.coordinates||!e.type)throw"Terraformer: invalid input for Terraformer.GeometryCollection";this.type="GeometryCollection",this.geometries=[e]}this.type="GeometryCollection",this.__defineGetter__("length",function(){return this.geometries?this.geometries.length:0}),this.__defineGetter__("bbox",function(){return f(this)})}function Q(e,t,n){var r=b(e),i=n||64,s=t||250,o={type:"Polygon",coordinates:[[]]};for(var u=1;u<=i;u++){var a=u*(360/i)*Math.PI/180;o.coordinates[0].push([r[0]+s*Math.cos(a),r[1]+s*Math.sin(a)])}return S(o)}function G(e,t,n){var r=n||64,i=t||250;if(!e||e.length<2||!i||!r)throw new Error("Terraformer: missing parameter for Terraformer.Circle");u(this,new $({type:"Feature",geometry:Q(e,i,r),properties:{radius:i,center:e,steps:r}})),this.__defineGetter__("bbox",function(){return f(this)}),this.__defineGetter__("radius",function(){return this.properties.radius}),this.__defineSetter__("radius",function(e){this.properties.radius=e,this.recalculate()}),this.__defineGetter__("steps",function(){return this.properties.steps}),this.__defineSetter__("steps",function(e){this.properties.steps=e,this.recalculate()}),this.__defineGetter__("center",function(){return this.properties.center}),this.__defineSetter__("center",function(e){this.properties.center=e,this.recalculate()})}var e={},t=6378137,n=57.29577951308232,r=.017453292519943,i={type:"link",properties:{href:"http://spatialreference.org/ref/sr-org/6928/ogcwkt/",type:"ogcwkt"}},s={type:"link",properties:{href:"http://spatialreference.org/ref/epsg/4326/ogcwkt/",type:"ogcwkt"}},I=["length","bbox"];return q.prototype={toMercator:function(){return E(this)},toGeographic:function(){return S(this)},envelope:function(){var e=f(this);return{x:e[0],y:e[1],w:Math.abs(e[0]-e[2]),h:Math.abs(e[1]-e[3])}},convexHull:function(){var e=[],t,n;if(this.type==="Point")return this.coordinates&&this.coordinates.length>0?[this.coordinates]:[];if(this.type==="LineString"||this.type==="MultiPoint"){if(!(this.coordinates&&this.coordinates.length>0))return[];e=this.coordinates}else if(this.type==="Polygon"||this.type==="MultiLineString"){if(!(this.coordinates&&this.coordinates.length>0))return[];for(t=0;t<this.coordinates.length;t++)e=e.concat(this.coordinates[t])}else{if(this.type!=="MultiPolygon")throw new Error("Unable to get convex hull of "+this.type);if(!(this.coordinates&&this.coordinates.length>0))return[];for(t=0;t<this.coordinates.length;t++)for(n=0;n<this.coordinates[t].length;n++)e=e.concat(this.coordinates[t][n])}return k(e)},toJSON:function(){var e={};for(var t in this)this.hasOwnProperty(t)&&this[t]&&I.indexOf(t)&&(e[t]=this[t]);return e.bbox=f(this),e},toJson:function(){return JSON.stringify(this)}},q.prototype.intersects=function(e){e.type==="Feature"&&(e=e.geometry);if(this.type==="LineString"){if(e.type==="LineString")return M(this.coordinates,e.coordinates);if(e.type==="MultiLineString")return _(this.coordinates,e.coordinates);if(e.type==="Polygon")return _(this.coordinates,j(e.coordinates));if(e.type==="MultiPolygon")return P(this.coordinates,e.coordinates)}else if(this.type==="MultiLineString"){if(e.type==="LineString")return _(e.coordinates,this.coordinates);if(e.type==="Polygon"||e.type==="MultiLineString")return D(this.coordinates,e.coordinates);if(e.type==="MultiPolygon")return H(this.coordinates,e.coordinates)}else if(this.type==="Polygon"){if(e.type==="LineString")return _(e.coordinates,j(this.coordinates));if(e.type==="MultiLineString")return D(j(this.coordinates),e.coordinates);if(e.type==="Polygon")return D(j(this.coordinates),j(e.coordinates));if(e.type==="MultiPolygon")return H(j(this.coordinates),e.coordinates)}else if(this.type==="MultiPolygon"){if(e.type==="LineString")return P(e.coordinates,this.coordinates);if(e.type==="Polygon"||e.type==="MultiLineString")return H(j(e.coordinates),this.coordinates);if(e.type==="MultiPolygon")return B(this.coordinates,e.coordinates)}else if(this.type==="Feature"){var t=new q(this.geometry);return t.intersects(e)}return o("Type "+this.type+" to "+e.type+" intersection is not supported by intersects"),!1},R.prototype=new q,R.prototype.constructor=R,U.prototype=new q,U.prototype.constructor=U,U.prototype.forEach=function(e){for(var t=0;t<this.length;t++)e.apply(this,[this.coordinates[t],t,this.coordinates]);return this},U.prototype.addPoint=function(e){return this.coordinates.push(e),this},U.prototype.insertPoint=function(e,t){return this.coordinates.splice(t,0,e),this},U.prototype.removePoint=function(e){return typeof e=="number"?this.coordinates.splice(e,1):this.coordinates.splice(this.coordinates.indexOf(e),1),this},U.prototype.get=function(e){return new R(this.coordinates[e])},z.prototype=new q,z.prototype.constructor=z,z.prototype.addVertex=function(e){return this.coordinates.push(e),this},z.prototype.insertVertex=function(e,t){return this.coordinates.splice(t,0,e),this},z.prototype.removeVertex=function(e){return this.coordinates.splice(e,1),this},W.prototype=new q,W.prototype.constructor=W,W.prototype.forEach=function(e){for(var t=0;t<this.coordinates.length;t++)e.apply(this,[this.coordinates[t],t,this.coordinates])},W.prototype.get=function(e){return new z(this.coordinates[e])},X.prototype=new q,X.prototype.constructor=X,X.prototype.addVertex=function(e){return this.coordinates[0].push(e),this},X.prototype.insertVertex=function(e,t){return this.coordinates[0].splice(t,0,e),this},X.prototype.removeVertex=function(e){return this.coordinates[0].splice(e,1),this},X.prototype.contains=function(e){if(e.type==="Point")return A(this.coordinates,e.coordinates);if(e.type==="Polygon"){if(e.coordinates.length>0&&e.coordinates[0].length>0&&A(this.coordinates,e.coordinates[0][0])===!0&&this.intersects(e)===!1)return!0}else if(e.type==="MultiPolygon"&&e.coordinates.length>0)for(var t=0;t<e.coordinates.length;t++)if(e.coordinates[t][0].length>0&&A(this.coordinates,e.coordinates[t][0][0])===!0&&this.intersects({type:"Polygon",coordinates:e.coordinates[t]})===!1)return!0;return!1},V.prototype=new q,V.prototype.constructor=V,V.prototype.forEach=function(e){for(var t=0;t<this.coordinates.length;t++)e.apply(this,[this.coordinates[t],t,this.coordinates])},V.prototype.contains=function(e){if(e.type!=="Point")throw new Error("Only points are supported");for(var t=0;t<this.coordinates.length;t++)if(A(this.coordinates[t],e.coordinates))return!0;return!1},V.prototype.get=function(e){return new X(this.coordinates[e])},$.prototype=new q,$.prototype.constructor=$,$.prototype.contains=function(e){if(e.type!=="Point")throw new Error("Only points are supported");if(!this.geometry.type.match(/Polygon/))throw new Error("Only features containing Polygons and MultiPolygons are supported");if(this.geometry.type==="MultiPolygon")for(var t=0;t<this.geometry.coordinates.length;t++)if(A(this.geometry.coordinates[t],e.coordinates))return!0;return this.geometry.type==="Polygon"?A(this.geometry.coordinates,e.coordinates):!1},J.prototype=new q,J.prototype.constructor=J,J.prototype.forEach=function(e){for(var t=0;t<this.features.length;t++)e.apply(this,[this.features[t],t,this.features])},J.prototype.get=function(e){var t;return this.forEach(function(n){n.id===e&&(t=n)}),new $(t)},K.prototype=new q,K.prototype.constructor=K,K.prototype.forEach=function(e){for(var t=0;t<this.geometries.length;t++)e.apply(this,[this.geometries[t],t,this.geometries])},K.prototype.get=function(e){return new q(this.geometries[e])},G.prototype=new q,G.prototype.constructor=G,G.prototype.recalculate=function(){return this.geometry=Q(this.center,this.radius,this.steps),this},G.prototype.contains=function(e){if(e.type!=="Point")throw new Error("Only points are supported");return A(this.geometry.coordinates,e.coordinates)},G.prototype.toJSON=function(){var e=q.prototype.toJSON.call(this);return e.properties.center=e.center,e.properties.steps=e.steps,e.properties.radius=e.radius,delete e.center,delete e.steps,delete e.radius,e},e.Primitive=q,e.Point=R,e.MultiPoint=U,e.LineString=z,e.MultiLineString=W,e.Polygon=X,e.MultiPolygon=V,e.Feature=$,e.FeatureCollection=J,e.GeometryCollection=K,e.Circle=G,e.toMercator=E,e.toGeographic=S,e.Tools={},e.Tools.positionToMercator=b,e.Tools.positionToGeographic=y,e.Tools.applyConverter=w,e.Tools.toMercator=E,e.Tools.toGeographic=S,e.Tools.createCircle=Q,e.Tools.calculateBounds=f,e.Tools.coordinatesContainPoint=L,e.Tools.polygonContainsPoint=A,e.Tools.convexHull=k,e.MercatorCRS=i,e.GeographicCRS=s,e});